<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Make7 Game</title>
    <script src="phaser.js"></script>
    <script src="phaser.min.js"></script>
    <script src="GAME_CONST.js"></script>
    <script src="HexCell.js"></script>
    <script src="RandomGenerator.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    Math.seedrandom('45');

    var game = new Phaser.Game(500, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

    var newTileType;
    var isLastTileSet = false;
    var cellsArray = [];

    var highlighter = null;

    var tileArray = ['oneTile', 'twoTile', 'threeTile'];
    var tileXpositions = [90, 122, 154, 186, 218, 250, 284, 316, 348, 380, 412];
    var tileYpositions = [112, 168, 224, 280, 336, 392];

    var allowedPositions = [[188, 150], [252, 150], [316, 150], [156, 206], [220, 206], [284, 206], [344, 206]];

    var newTilePositionX = 216;
    var newTilePositionY = 500;

    function preload() {

        this.load.image('board', 'assets/board.png');
        this.load.image('oneTile', 'assets/1.png');
        this.load.image('twoTile', 'assets/2.png');
        this.load.image('threeTile', 'assets/3.png');
        this.load.image('fourTile', 'assets/4.png');
        this.load.image('fiveTile', 'assets/5.png');
        this.load.image('sixTile', 'assets/6.png');
        this.load.image('sevenTile', 'assets/7.png');

    }

    function create() {
        this.game.physics.startSystem(Phaser.Physics.ARCADE);
        game.add.image(80, 100, 'board');

        createHexCells();
        createNewTile();
    }

    function update() {
        if(isLastTileSet === true) {
            createNewTile();
            isLastTileSet = false;
        }
    }

    function onDragStop(sprite, pointer) {

        var xPosition = newTilePositionX, yPosition = newTilePositionY;
        removeHighlighter();

        var matchingIndex = checkMatchingTile(pointer);
        if(matchingIndex !== -1) {
            xPosition = cellsArray[matchingIndex].frame[0] - 30;
            yPosition = cellsArray[matchingIndex].frame[1] - 32;
            cellsArray[matchingIndex].spriteObject = sprite;
        }

        if(xPosition != newTilePositionX && yPosition != newTilePositionY) {
            sprite.position.setTo(xPosition, yPosition);
            sprite.input.draggable = false;

            isLastTileSet = true;
        } else {
            sprite.position.setTo(newTilePositionX, newTilePositionY);
        }

    }

    function removeHighlighter() {
        if(highlighter != null) {
            console.log('deleting highlighter');
            highlighter.destroy();
            highlighter = null;
        }
    }

    function onDragUpdate(sprite, pointer) {
        var matchingIndex = checkMatchingTile(pointer);
        if(matchingIndex !== -1 && cellsArray[matchingIndex].spriteObject == null) {
            removeHighlighter();
            highlighter = game.add.image(cellsArray[matchingIndex].frame[0] - 30, cellsArray[matchingIndex].frame[1] - 32, 'oneTile');
        } else {
            removeHighlighter();
        }
        sprite.bringToTop();
        console.log('dragUpdate')
    }

    function checkMatchingTile(pointer) {
        for(var index = 0; index < cellsArray.length; index++) {
            if((Math.abs(pointer.x - cellsArray[index].frame[0]) + Math.abs(pointer.y - cellsArray[index].frame[1]) < 30) && cellsArray[index].spriteObject == null) {
                return index;
            }
        }
        return -1;
    }

    function createNewTile() {
        newTileType = tileArray[Math.floor(Math.random() * 3)];
        var newTile = game.add.sprite(newTilePositionX, newTilePositionY, newTileType);
        newTile.events.onDragStop.add(onDragStop, this);
        newTile.events.onDragUpdate.add(onDragUpdate, this);
        newTile.inputEnabled = true;
        newTile.input.enableDrag(true);
    }

    function createHexCells() {
        cellsArray.push(createCellObject([-2,-2], [188, 150], null));
        cellsArray.push(createCellObject([0,-2], [252, 150], null));
        cellsArray.push(createCellObject([2,-2], [316, 150], null));
        cellsArray.push(createCellObject([-3,-1], [156, 206], null));
        cellsArray.push(createCellObject([-1,-1], [220, 206], null));
        cellsArray.push(createCellObject([1,-1], [284, 206], null));
        cellsArray.push(createCellObject([3,-1], [348, 206], null));
        cellsArray.push(createCellObject([-4,0], [124, 262], null));
        cellsArray.push(createCellObject([-2,0], [188, 262], null));
        cellsArray.push(createCellObject([0,0], [252, 262], null));
        cellsArray.push(createCellObject([2,0], [316, 262], null));
        cellsArray.push(createCellObject([4,0], [380, 262], null));
        cellsArray.push(createCellObject([-3,1], [156, 318], null));
        cellsArray.push(createCellObject([-1,1], [220, 318], null));
        cellsArray.push(createCellObject([1,1], [284, 318], null));
        cellsArray.push(createCellObject([3,1], [348, 318], null));
        cellsArray.push(createCellObject([-2,2], [188, 374], null));
        cellsArray.push(createCellObject([0,2], [252, 374], null));
        cellsArray.push(createCellObject([2,2], [316, 374], null));
    }

</script>

</body>
</html>