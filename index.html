<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Make7 Game</title>
    <script src="phaser.js"></script>
    <script src="phaser.min.js"></script>
    <script src="GAME_CONST.js"></script>
    <script src="HexCell.js"></script>
    <script src="RandomGenerator.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    Math.seedrandom('45');

    let directions = [[1, -1], [2, 0], [1, 1], [-1, 1], [-2, 0], [-1, -1]]
    let cellsArraySize = 19;
    let numberSeven = 7
    var visitedCells;
    var cellIndicesToBeMerged;

    var game = new Phaser.Game(500, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

    var newTileType;
    var isLastTileSet = false;
    var cellsArray = [];

    var highlighter = null;

    var tileArray = ['1', '2', '3'];
    var tileXpositions = [90, 122, 154, 186, 218, 250, 284, 316, 348, 380, 412];
    var tileYpositions = [112, 168, 224, 280, 336, 392];

    var allowedPositions = [[188, 150], [252, 150], [316, 150], [156, 206], [220, 206], [284, 206], [344, 206]];

    var newTilePositionX = 246;
    var newTilePositionY = 532;

    function preload() {

        this.load.image('board', 'assets/board.png');
        this.load.image('1', 'assets/1.png');
        this.load.image('2', 'assets/2.png');
        this.load.image('3', 'assets/3.png');
        this.load.image('4', 'assets/4.png');
        this.load.image('5', 'assets/5.png');
        this.load.image('6', 'assets/6.png');
        this.load.image('7', 'assets/7.png');

    }

    function create() {
        this.game.physics.startSystem(Phaser.Physics.ARCADE);
        game.add.image(80, 100, 'board');

        createHexCells();
        createNewTile();
    }

    function update() {
        if(isLastTileSet === true) {
            createNewTile();
            isLastTileSet = false;
        }
    }

    function declareGameEnd(didMakeSeven) {
        if (didMakeSeven) {
            console.log('YOU WON')
        } else {
            console.log('YOU LOST')
        }
    }

    function mergeCells(destinationIndex) {
        let currentSpriteNumber = parseInt(cellsArray[destinationIndex].sprite.key) 
        let resultantNumber = currentSpriteNumber + 1
        let resultantSpriteKey = (resultantNumber).toString()

        let finalXPos = cellsArray[destinationIndex].frame[0],
            finalYPos = cellsArray[destinationIndex].frame[1];
        let maxTime = 500
        let defaultSpeed = 60
        for (var index = 0; index < cellIndicesToBeMerged.length; index++) {
            if (cellIndicesToBeMerged[index] != destinationIndex ) {
                let cell = cellsArray[cellIndicesToBeMerged[index]]
                game.physics.arcade.enable(cell.sprite)
                game.physics.arcade.moveToXY(cell.sprite, finalXPos, finalYPos, defaultSpeed, maxTime)
            }
        }

        setTimeout(function() { 
            for (var index = 0; index < cellIndicesToBeMerged.length; index++) {
                let cell = cellsArray[cellIndicesToBeMerged[index]]
                cell.sprite.destroy()
                cell.sprite = null
            }
            let sprite = game.add.sprite(finalXPos, finalYPos, resultantSpriteKey);
            sprite.anchor.setTo(0.5, 0.5)
            cellsArray[destinationIndex].sprite = sprite
            if (resultantNumber < numberSeven) {
                mergeCellsIfRequired(destinationIndex)
            } else {
                declareGameEnd(true)
            }

        }, maxTime)
    }

    function evaluateCellsToBeMerged(currentIndex, matchingKey) {
        visitedCells[currentIndex] = true;
        if (cellsArray[currentIndex].sprite == null || cellsArray[currentIndex].sprite.key != matchingKey) {
            return;
        }
        cellIndicesToBeMerged.push(currentIndex);

        for(var index = 0; index < directions.length; index++) {
            let newXPos = cellsArray[currentIndex].key[0] + directions[index][0],
                newYPos = cellsArray[currentIndex].key[1] + directions[index][1] ;

            let neighbourCellIndex = getHexCellForIndex(newXPos, newYPos);
            if (neighbourCellIndex != -1 && !visitedCells[neighbourCellIndex]) {
                evaluateCellsToBeMerged(neighbourCellIndex, matchingKey);
            }
        }
    }

    function mergeCellsIfRequired(startIndex) {
        visitedCells = Array(cellsArraySize).fill(false);
        cellIndicesToBeMerged = Array(0);
        evaluateCellsToBeMerged(startIndex, cellsArray[startIndex].sprite.key);
        if (cellIndicesToBeMerged.length >= 3) {
            mergeCells(startIndex);
        }
    }

    function onDragStop(sprite, pointer) {

        var xPosition = newTilePositionX, yPosition = newTilePositionY;
        removeHighlighter();

        var matchingIndex = checkMatchingTile(pointer);
        if(matchingIndex !== -1) {
            xPosition = cellsArray[matchingIndex].frame[0];
            yPosition = cellsArray[matchingIndex].frame[1];
            cellsArray[matchingIndex].sprite = sprite;
            mergeCellsIfRequired(matchingIndex)
        }

        if(xPosition != newTilePositionX && yPosition != newTilePositionY) {
            sprite.position.setTo(xPosition, yPosition);
            sprite.input.draggable = false;

            isLastTileSet = true;
        } else {
            sprite.position.setTo(newTilePositionX, newTilePositionY);
        }

    }

    function removeHighlighter() {
        if(highlighter != null) {
            highlighter.destroy();
            highlighter = null;
        }
    }

    function onDragUpdate(sprite, pointer) {
        var matchingIndex = checkMatchingTile(pointer);
        if(matchingIndex !== -1 && cellsArray[matchingIndex].spriteObject == null) {
            removeHighlighter();
            highlighter = game.add.image(cellsArray[matchingIndex].frame[0] - 30, cellsArray[matchingIndex].frame[1] - 32, '1');
        } else {
            removeHighlighter();
        }
        sprite.bringToTop();
    }

    function checkMatchingTile(pointer) {
        for(var index = 0; index < cellsArray.length; index++) {
            if((Math.abs(pointer.x - cellsArray[index].frame[0]) + Math.abs(pointer.y - cellsArray[index].frame[1]) < 30) && cellsArray[index].spriteObject == null) {
                return index;
            }
        }
        return -1;
    }

    function createNewTile() {
        newTileType = tileArray[Math.floor(Math.random() * 3)];
        var newTile = game.add.sprite(newTilePositionX, newTilePositionY, newTileType);
        newTile.anchor.setTo(0.5, 0.5)
        newTile.events.onDragStop.add(onDragStop, this);
        newTile.events.onDragUpdate.add(onDragUpdate, this);
        newTile.inputEnabled = true;
        newTile.input.enableDrag(true);
    }

    function getHexCellForIndex(x, y) {
        if (Math.abs(x) + Math.abs(y) > 4) {
            return -1
        }
        for( var index = 0 ; index < cellsArray.length; index++) {
            if (cellsArray[index].key[0] == x &&  cellsArray[index].key[1] == y) {
                return index
            }
        }
        return -1
    }

    function createHexCells() {
        cellsArray.push(createCellObject([-2,-2], [188, 150], null));
        cellsArray.push(createCellObject([0,-2], [252, 150], null));
        cellsArray.push(createCellObject([2,-2], [316, 150], null));
        cellsArray.push(createCellObject([-3,-1], [156, 206], null));
        cellsArray.push(createCellObject([-1,-1], [220, 206], null));
        cellsArray.push(createCellObject([1,-1], [284, 206], null));
        cellsArray.push(createCellObject([3,-1], [348, 206], null));
        cellsArray.push(createCellObject([-4,0], [124, 262], null));
        cellsArray.push(createCellObject([-2,0], [188, 262], null));
        cellsArray.push(createCellObject([0,0], [252, 262], null));
        cellsArray.push(createCellObject([2,0], [316, 262], null));
        cellsArray.push(createCellObject([4,0], [380, 262], null));
        cellsArray.push(createCellObject([-3,1], [156, 318], null));
        cellsArray.push(createCellObject([-1,1], [220, 318], null));
        cellsArray.push(createCellObject([1,1], [284, 318], null));
        cellsArray.push(createCellObject([3,1], [348, 318], null));
        cellsArray.push(createCellObject([-2,2], [188, 374], null));
        cellsArray.push(createCellObject([0,2], [252, 374], null));
        cellsArray.push(createCellObject([2,2], [316, 374], null));
    }

</script>

</body>
</html>